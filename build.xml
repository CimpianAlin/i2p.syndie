<?xml version="1.0" encoding="UTF-8"?>
<project name="syndie" default="run" basedir=".">
    <description>Builds, tests and runs the project syndie.</description>
  
  <!-- Set some global properties up -->
    <property name="src.dir" value="src" />
    <property name="build.dir" value="build" />
    <property name="dist.dir" value="dist" />
    <property name="lib.dir" value="lib" />
    <property name="dist.lib.jar" value="${dist.dir}/syndie.jar" />
  
  <!-- Set some classpaths up -->
    <path id="classpath.build">
        <fileset dir="${lib.dir}">
            <include name="hsqldb.jar" />
            <include name="i2p.jar" />
            <include name="swt.jar" />
        </fileset>
    </path>
    <path id="classpath.run">
        <pathelement location="${dist.lib.jar}" />
        <path refid="classpath.build" />
    </path>
  
  <!-- Set up a fileset for the resources -->
    <path id="resources.path">
        <fileset dir="${src.dir}">
            <exclude name="**/*.java" />
            <exclude name="MANIFEST.MF" />
        </fileset>
    </path>
  
  
    <target name="init">
        <tstamp />
        <mkdir dir="${dist.dir}" />
        <mkdir dir="${build.dir}" />
    </target>
  
    <target name="compile" depends="init" description="compile the source">
        <javac srcdir="${src.dir}" destdir="${build.dir}" debug="true" source="1.5" target="1.5">
            <classpath>
                <path refid="classpath.build" />
            </classpath>
        </javac>
        <copy todir="${build.dir}">
            <path refid="resources.path" />
        </copy>
    </target>
  
    <target name="jar" depends="compile" description="generate the jar file">
        <jar jarfile="${dist.lib.jar}" basedir="${build.dir}" />
    </target>

    <target name="dist" depends="jar" description="Combine all jars">
        <jar jarfile="syndie.jar" index="true">
            <manifest>
                <attribute name="Main-Class" value="syndie.gui.SWTUI"/>
            </manifest>
            <zipfileset src="${dist.lib.jar}" includes="**" />
            <zipgroupfileset dir="lib" includes="*.jar"/>
        </jar>
    </target>
  
    <target name="run" depends="jar" description="run syndie">
        <condition property="run.args" value="">
            <not>
                <isset property="run.args" />
            </not>
        </condition>
        <java classname="syndie.gui.SWTUI" fork="true" failonerror="false">
            <arg line="${run.args}" />
            <classpath>
                <path refid="classpath.run" />
            </classpath>
        </java>
    </target>
  
    <target name="plugin" depends="jar"> 
        <mkdir dir="plugin/lib" />

        <exec executable="grep" outputproperty="versionLine" failonerror="true" >
            <arg value="public static final String VERSION" />
	    <arg value="src/syndie/Version.java" />
        </exec>
        <exec executable="cut" inputstring="${versionLine}" outputproperty="release.number" failonerror="true" >
            <arg value="-f2" />
	    <arg value="-d&quot;" />
        </exec>
        <buildnumber file="scripts/build.number" />

        <!-- make the update xpi2p -->
        <delete file="plugin/lib/hsqldb.jar.pack" />
        <delete file="plugin/lib/swt.jar.pack" />
        <copy file="LICENSE" todir="plugin" />
        <copy file="logger.config" todir="plugin" />
        <copy file="scripts/plugin-linux.config" tofile="plugin/plugin.config" overwrite="true" />
        <copy file="scripts/clients-linux.config" tofile="plugin/clients.config" overwrite="true" />
        <exec executable="echo" osfamily="unix" failifexecutionfails="true" output="plugin/plugin.config" append="true">
            <arg value="version=${release.number}-b${build.number}" />
        </exec>
        <exec executable="echo" osfamily="unix" failifexecutionfails="true" output="plugin/plugin.config" append="true">
            <arg value="update-only=true" />
        </exec>
        <exec executable="pack200" failifexecutionfails="true">
            <arg value="-g" />
            <arg value="plugin/lib/syndie.jar.pack" />
            <arg value="${dist.dir}/syndie.jar" />
        </exec>
        <exec executable="scripts/makeplugin.sh" >
            <arg value="plugin" />
        </exec>
        <move file="syndie.xpi2p" tofile="syndie-linux-i386-update.xpi2p" />

        <!-- make the windows update xpi2p -->
        <copy file="scripts/plugin-windows.config" tofile="plugin/plugin.config" overwrite="true" />
        <exec executable="echo" osfamily="unix" failifexecutionfails="true" output="plugin/plugin.config" append="true">
            <arg value="version=${release.number}-b${build.number}" />
        </exec>
        <exec executable="echo" osfamily="unix" failifexecutionfails="true" output="plugin/plugin.config" append="true">
            <arg value="update-only=true" />
        </exec>
        <copy file="scripts/clients-windows.config" tofile="plugin/clients.config" overwrite="true" />
        <exec executable="scripts/makeplugin.sh" >
            <arg value="plugin" />
        </exec>
        <move file="syndie.xpi2p" tofile="syndie-win32-update.xpi2p" />

        <!-- make the install xpi2p -->
        <copy file="lib/hsqldb_lic.txt" todir="plugin" />
        <copy file="scripts/plugin-linux.config" tofile="plugin/plugin.config" overwrite="true" />
        <copy file="scripts/clients-linux.config" tofile="plugin/clients.config" overwrite="true" />
        <exec executable="echo" osfamily="unix" failifexecutionfails="true" output="plugin/plugin.config" append="true">
            <arg value="version=${release.number}-b${build.number}" />
        </exec>
        <exec executable="pack200" failifexecutionfails="true">
            <arg value="-g" />
            <arg value="plugin/lib/hsqldb.jar.pack" />
            <arg value="${lib.dir}/hsqldb.jar" />
        </exec>
        <exec executable="pack200" failifexecutionfails="true">
            <arg value="-g" />
            <arg value="plugin/lib/swt.jar.pack" />
            <arg value="${lib.dir}/swt.jar" />
        </exec>
        <exec executable="scripts/makeplugin.sh" >
            <arg value="plugin" />
        </exec>
        <move file="syndie.xpi2p" tofile="syndie-linux-i386.xpi2p" />

        <!-- make the windows install xpi2p -->
        <copy file="scripts/plugin-windows.config" tofile="plugin/plugin.config" overwrite="true" />
        <copy file="scripts/clients-windows.config" tofile="plugin/clients.config" overwrite="true" />
        <exec executable="echo" osfamily="unix" failifexecutionfails="true" output="plugin/plugin.config" append="true">
            <arg value="version=${release.number}-b${build.number}" />
        </exec>
        <exec executable="pack200" failifexecutionfails="true">
            <arg value="-g" />
            <arg value="plugin/lib/swt.jar.pack" />
            <arg value="${lib.dir}/swt-win32.jar" />
        </exec>
        <exec executable="scripts/makeplugin.sh" >
            <arg value="plugin" />
        </exec>
        <move file="syndie.xpi2p" tofile="syndie-win32.xpi2p" />

    </target>
  
  
    <target name="clean" description="clean up">
        <delete dir="${build.dir}" />
        <delete dir="${dist.dir}" />
        <delete dir="plugin/lib" />
        <delete file="plugin/clients.config" />
        <delete file="plugin/logger.config" />
        <delete file="plugin/plugin.config" />
        <delete file="plugin/LICENSE" />
        <delete file="plugin/hsqldb_lic.txt" />
        <delete file="syndie.xpi2p" />
        <delete file="syndie-update.xpi2p" />
    </target>
</project>
