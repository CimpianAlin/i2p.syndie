<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
<title>Syndie - archives</title>
<link rel="stylesheet" href="style.css" type="text/css" title="normal" media="screen" />
</head>
<body>
<div style="display: none"><a href="#Content" title="Skip navigation" accesskey="2">Skip navigation</a></div>
<div id="Header">
 <a href="index.html" title="Syndie">Syndie</a><i> - distributed forums</i>
</div>
<div id="Menu">
	<a href="index.html" title="Home">Home</a><br />
	<a href="download.html" title="Download Syndie">Download</a><br />
	<a href="features.html" title="Syndie Features">Features</a><br />
	<a href="usecases.html" title="Use cases">Use cases</a><br />
	<a href="faq.html" title="Frequently Asked Questions">Faq</a><br />
	<a href="roadmap.html" title="Roadmap">Roadmap</a><br />
	<a href="dev.html" title="Developers">Developers</a><br />
	<a href="manual.html" title="">Manual</a><br />
	<a href="donate.html" title="Help Syndie">Donate</a><br />
	<a href="related.html" title="Related projects">Related projects</a><br />
	<a href="about.html" title="About Syndie">About</a><br />
	<hr />
	<a href="http://forum.i2p.net/viewforum.php?f=29">Forum</a><br />
	<hr />
	<a href="dev.html">Code</a><br />
	<a href="spec.html">Specs</a><br />
	<a href="archive.html">Archives</a><br />
	<a href="db.html">Database</a><br />
</div>
<div id="Content">
<h1>Syndie archives</h1>
<p>Each Syndie instance operates with its own archive of messages, storing
the data extracted from the <a href="spec.html#message">signed messages</a>
within its local <a href="db.html">database</a> (by default stored under
<code>$dataRoot/db/</code>), an archive of those signed messages in the
<code>$dataRoot/archive/</code> file hierarchy, and an archive of locally
created but not yet distributed messages in the
<code>$dataRoot/outbound/</code> file hierarchy.  The contents of
<code>$dataRoot/archive/</code> can be wiped out without any loss of
functionality, though doing so prevents the Syndie instance from sharing
the authenticated messages with other people.</p>

<p>Within the <code>$dataRoot/archive/</code> directory, each channel
has its own subdirectory containing the channel's metadata (in <code>meta.syndie</code>)
and posts (in <code>$messageId.syndie</code>).  In addition, there are three
index files for each channel (<code>index-all.dat, index-new.dat,
index-unauthorized.dat</code>) as well as four index files for the
entire archive itself (<code>index-all.dat, index-meta.dat, index-new.dat,
index-unauthorized.dat</code>).  These indexes are rebuilt with the
<a href="manual.html#syndicate_buildindex">buildindex</a> command, summarizing all posts
in the channel/archive (<code>index-all.dat</code>
and <code>$channelHash/index-all.dat</code>), all posts received or published
in the last few days (<code>index-new.dat</code> and
<code>$channelHash/index-new.dat</code>),
the metadata editions of all known channels (<code>index-meta.dat</code>),
and all posts for individual
channels that are not authorized (<code>index-unauthorized.dat</code> and
<code>$channelHash/index-unauthorized.dat</code>).</p>

<p>The index files all use the following format:</p><pre>
    $channelHash        // 32 byte SHA256 value
    $channelEdition     // 4 byte unsigned integer
    $reciveDate         // 4 byte unsigned integer - days since 1970/1/1
    $metaFileSize       // 4 byte unsigned integer - size of the meta.syndie file
    $numMessages        // 4 byte unsigned integer - how many messages are known
    $indexedMessages    // 4 byte unsigned integer - # messages following
    for (i = 0; i < $indexedMessages; i++)
       $messageId       // 8 byte unsigned integer
       $receiveDate     // 4 byte unsigned integer - days since 1970/1/1
       $entryFileSize   // 4 byte unsigned integer - size of $messageId.syndie
       $flags           // 1 byte.
                        // 1<<7: authorized
                        // 1<<6: private reply
                        // 1<<5: password based encrypted
                        // 1<<4: archive considers the post "new"
    // external chan refs in index-all and index-new refer to posts that
    // are in another scope but both target this $channelHash scope and
    // are authorized.  unsigned chan refs in index-unauthorized are the
    // same, but not authorized
    $externalChanRefs   // 4 byte unsigned integer - # channels following
    for (i = 0; i < $externalChanRefs; i++)
       $scopeHash       // 32 byte SHA256 value that the post is in
       $posts           // 4 byte unsigned integer - messages following
       for (j = 0; j < $posts;  j++
           $messageId       // 8 byte unsigned integer
           $receiveDate     // 4 byte unsigned integer - days since 1970/1/1
           $entrySize       // 4 byte unsigned integer - sizeof .syndie file
           $flags           // 1 byte.
                            // 1<<7: authorized
                            // 1<<6: private reply
                            // 1<<5: password based encrypted
                            // 1<<4: archive considers the post "new"
</pre>

<p>Individual posts are found under
<code>$dataRoot/archive/$scope/$messageId.syndie</code>, and metadata under
<code>$dataRoot/archive/$scope/meta.syndie</code>.  The externally referenced
posts are found under their original scope path, not the targetted channel
path - <code>$dataRoot/archive/$scopeHash/$messageId.syndie</code> and not
<code>$dataRoot/archive/$channelHash/$messageId.syndie</code></p>

<p>The <code>$dataRoot/archive/index-*dat</code> files simply concatenate the
<code>$dataRoot/archive/$channelHash/index-*.dat</code> files together.
These file formats are implemented in the <code>syndie.db.ArchiveIndex</code>
class, and are subject to change.</p>

<p>Given the simple file-based archive hierarchy and index, running a public
Syndie archive is trivial - simply publish your <code>$dataRoot/archive/</code>
in a webserver and tell people the URL.  They will then be able to load up
their Syndie instance and use the <a href="manual.html#getindex">getindex and fetch</a>
commands to pull posts from the archive into their local Syndie instance.</p>

<p>Syndie also includes a built-in HTTP server (run with the
<a href="manual.html#httpserv">httpserv</a> command), which both serves up the
content and accepts HTTP posts from others (if allowed).</p>

<p>The server accepts posts (uploaded through
<a href="manual.html">schedule and put</a>), writing them to a temporary directory
under the syndie root, and running <a href="manual.html#bulkimport">bulkimport</a>
on them after they've all been read.</p>

<p>The HTTP post received is not a mime-encoded post, but a fairly simple concatenation
of all of the data to be uploaded (with metadata messages first):</p>
<pre>
  POST /import.cgi\r\n
  Content-length: $total\r\n
  \r\n
  $headerSize	// 2 bytes
  $header	// $headerSize bytes, for authorization/etc 
  foreach (msg)
    $msgFlags	// 1 byte.  0x0 for normal posts, 0x1 for metadata posts
    $msgSize	// 4 bytes
    $msgData	// $msgSize bytes
</pre>

</div>
</body>
</html>
